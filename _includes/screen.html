<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Some Antics Scenes</title>
	<script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
	<link rel="stylesheet" href="/css/style.css" />
	<link rel="stylesheet" href="/css/chat.css" />
	<link rel="stylesheet" href="/css/tunas.css" />
</head>
<body>
	<div id="left">
		<section id="screen"></section>
		<header>
			<h1>{{ title }}</h1>
			<p class="twitter-handle">
				{% include partials/twitter-logo.html %}
				<span class="twitter-username">
					<span class="at">@</span>SomeAnticsDev
				</span>
			</p>
		</header>
	</div>
	<div id="right" {% if throuple %}class="throuple"{% endif %}>
		<section class="camera"></section>
		{% if pair %}<section class="camera"></section>{% endif %}
		{% if throuple %}<section class="camera"></section>{% endif %}
		<section id="chat">
			<ul></ul>
		</section>
	</div>
	<div id="tunas">
		<img src="/assets/tuna.png" id="tuna1" alt="" />
		<img src="/assets/tuna-from-front.png" id="tuna2" alt="" />
		<img src="/assets/majestic-boi.png" id="tuna3" alt="" />
		<img src="/assets/ceiling-tuna.png" id="tuna4" alt="" />
	</div>
	<script>
		function htmlEntities(html) {
			function it() {
				return html.map(function(n, i, arr) {
						if(n.length == 1) {
							return n.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
								return '&#'+i.charCodeAt(0)+';';
								});
						}
						return n;
					});
			}
			var isArray = Array.isArray(html);
			if(!isArray) {
				html = html.split('');
			}
			html = it(html);
			if(!isArray) html = html.join('');
			return html;
		}

		function formatEmotes(text, emotes) {
			var splitText = text.split('');
			for(var i in emotes) {
				var e = emotes[i];
				for(var j in e) {
					var mote = e[j];
					if(typeof mote == 'string') {
						mote = mote.split('-');
						mote = [parseInt(mote[0]), parseInt(mote[1])];
						var length =  mote[1] - mote[0],
							empty = Array.apply(null, new Array(length + 1)).map(function() { return '' });
						splitText = splitText.slice(0, mote[0]).concat(empty).concat(splitText.slice(mote[1] + 1, splitText.length));
						splitText.splice(mote[0], 1, `<img class="emote" src="http://static-cdn.jtvnw.net/emoticons/v1/${i}/3.0">`);
					}
				}
			}
			return htmlEntities(splitText).join('')
		}

		const chatbox = document.querySelector('#chat ul');

		/**
		 * Displays a message in the chat box.
		 * @param {string} user sender's display name
		 * @param {string} message message contents, not yet sanitized or emotified
		 * @param {Object<string, string[]>} emotes ranges for emotes in message contents
		 */
		function displayMessage(user, message, flags, self, extra) {
			const newMessage = document.createElement('li');

			// Format sender
			const sender = document.createElement('p');
			sender.classList.add('sender');
			let role;
			if (flags.broadcaster || user === 'BenDMyers') role = 'broadcaster';
			else if (flags.mod) role = 'mod';
			else if (flags.vip) role = 'vip';
			else if (flags.subscriber) role = 'subscriber';
			
			role && sender.classList.add(role);
			sender.innerText = user;

			// Format message
			const messageContents = document.createElement('p');
			messageContents.innerHTML = formatEmotes(message, extra.messageEmotes);

			newMessage.appendChild(sender);
			newMessage.appendChild(messageContents);
			newMessage.id = extra.id;

			chatbox.appendChild(newMessage);
		}

		ComfyJS.onChat = displayMessage;

		ComfyJS.onMessageDeleted = (id, extra) => {
			let deletedMessage = document.getElementById(id);
			if (deletedMessage) {
				deletedMessage.remove();
			}
		}

		ComfyJS.onSub = (user, message, subTierInfo, extra) => {
			const eventNotice = document.createElement('li');
			eventNotice.classList.add('event', 'sub');
			eventNotice.innerHTML = `<span class="event-user">${user}</span> subscribed!`;
			chatbox.appendChild(eventNotice);

			console.log({user, message, subTierInfo, extra});

			if (message) {
				displayMessage(user, message, {subscriber: true}, false, extra);
			}
		}

		ComfyJS.onResub = (user, message, streamMonths, cumulativeMonths, subTierInfo, extra) => {
			console.log({user, message, streamMonths, cumulativeMonths, subTierInfo, extra})
			const eventNotice = document.createElement('li');
			eventNotice.classList.add('event', 'sub');
			eventNotice.innerHTML = `<span class="event-user">${user}</span> resubscribed!`;
			chatbox.appendChild(eventNotice);

			if (message) {
				displayMessage(user, message, {subscriber: true}, false, extra);
			}
		}

		ComfyJS.onRaid = (user, viewers, extra) => {
			console.log({user, viewers, extra});
			const eventNotice = document.createElement('li');
			eventNotice.classList.add('event', 'raid');
			const viewerCount = (viewers === 1) ? '1 viewer' : `${viewers} viewers`;
			eventNotice.innerHTML = `<span class="event-user">${user}</span> is raiding with ${viewerCount}!`;
			chatbox.appendChild(eventNotice);
		}

		ComfyJS.onCommand = (user, command, message, flags, extra) => {
			if (command === 'tuna') {
				let tuna = document.querySelector('#tunas img');
				tuna.classList.add('active');
				setTimeout(() => {
					tuna.classList.remove('active');
				}, 7000);
			}
		}

		ComfyJS.Init('SomeAnticsDev');
	</script>
</body>
</html>